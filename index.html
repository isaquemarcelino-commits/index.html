using UnityEngine;
using UnityEngine.AI;

public class FootballGameComplete : MonoBehaviour
{
    [Header("REFERENCES")]
    public Rigidbody player;
    public Rigidbody ball;
    public NavMeshAgent aiPlayer;

    [Header("GOALS")]
    public Transform goalA;
    public Transform goalB;

    [Header("PLAYER SETTINGS")]
    public float moveSpeed = 8f;
    public float rotationSpeed = 720f;
    public float shotPower = 20f;
    public float passPower = 10f;
    public float kickRange = 2f;
    public float stamina = 100f;

    [Header("BALL SETTINGS")]
    public float ballDrag = 0.2f;
    public float ballAngularDrag = 0.05f;

    private int scoreA = 0;
    private int scoreB = 0;

    void Start()
    {
        ball.mass = 0.43f; // peso real bola futebol
        ball.drag = ballDrag;
        ball.angularDrag = ballAngularDrag;
    }

    void Update()
    {
        PlayerMovement();
        PlayerActions();
        AIBehaviour();
        CheckGoal();
    }

    void PlayerMovement()
    {
        float h = Input.GetAxis("Horizontal");
        float v = Input.GetAxis("Vertical");

        Vector3 direction = new Vector3(h, 0, v).normalized;

        if (direction.magnitude > 0.1f)
        {
            stamina -= Time.deltaTime * 5f;
            stamina = Mathf.Clamp(stamina, 0, 100);

            Vector3 move = direction * moveSpeed * Time.deltaTime;
            player.MovePosition(player.position + move);

            Quaternion targetRotation = Quaternion.LookRotation(direction);
            player.MoveRotation(Quaternion.RotateTowards(player.rotation, targetRotation, rotationSpeed * Time.deltaTime));
        }
        else
        {
            stamina += Time.deltaTime * 10f;
            stamina = Mathf.Clamp(stamina, 0, 100);
        }
    }

    void PlayerActions()
    {
        float distanceToBall = Vector3.Distance(player.position, ball.position);

        if (distanceToBall <= kickRange)
        {
            if (Input.GetKeyDown(KeyCode.Space))
            {
                Shoot();
            }

            if (Input.GetKeyDown(KeyCode.LeftShift))
            {
                Pass();
            }
        }
    }

    void Shoot()
    {
        Vector3 direction = player.transform.forward;
        ball.AddForce(direction * shotPower, ForceMode.Impulse);
        ball.AddTorque(Random.insideUnitSphere * 5f);
    }

    void Pass()
    {
        Vector3 direction = player.transform.forward;
        ball.AddForce(direction * passPower, ForceMode.Impulse);
    }

    void AIBehaviour()
    {
        if (aiPlayer != null)
        {
            aiPlayer.SetDestination(ball.position);

            float distance = Vector3.Distance(aiPlayer.transform.position, ball.position);

            if (distance < 2f)
            {
                Vector3 shootDir = (goalA.position - aiPlayer.transform.position).normalized;
                ball.AddForce(shootDir * shotPower, ForceMode.Impulse);
            }
        }
    }

    void CheckGoal()
    {
        if (Vector3.Distance(ball.position, goalA.position) < 2f)
        {
            scoreB++;
            ResetBall();
        }

        if (Vector3.Distance(ball.position, goalB.position) < 2f)
        {
            scoreA++;
            ResetBall();
        }
    }

    void ResetBall()
    {
        ball.velocity = Vector3.zero;
        ball.angularVelocity = Vector3.zero;
        ball.position = Vector3.zero;

        Debug.Log("Placar: Time A " + scoreA + " x " + scoreB + " Time B");
    }
}
